# This script (`before.sh.erb`) is sourced directly into the main Bash script
# that is run when the batch job starts up. It is called before the `script.sh`
# is forked off into a separate process.
#
# There are some helpful Bash functions that are made available to this script
# that encapsulate commonly used routines when initializing a web server:
#
#   - find_port
#       Find available port in range [$1..$2]
#       Default: 2000 65535
#
#   - create_passwd
#       Generate random alphanumeric password with $1 characters
#       Default: 32
#
# We **MUST** supply the following environment variables in this
# `before.sh.erb` script so that a user can connect back to the web server when
# it is running (case-sensitive variable names):
#
#   - $host (already defined earlier, so no need to define again)
#       The host that the web server is listening on
#
#   - $port
#       The port that the web server is listening on
#
#   - $password
#       The plain text password used to authenticate to the web server with

# Export the module function if it exists
[[ $(type -t module) == "function" ]] && export -f module

# Find available port to run server on
port=$(find_port)
app_port=$(find_port)

# Generate password
password="$(create_passwd 16)"

# The `$CONFIG_FILE` environment variable is exported as it is used in the main
# `script.sh.erb` file when launching the VSCode server.
export CONFIG_FILE="${PWD}/config.yml"
export PROXY_FILE="${PWD}/proxy.yml"

# Generate VSCode configuration file with secure file permissions
(
umask 077
cat > "${CONFIG_FILE}" << EOL
bind-addr: 0.0.0.0:${app_port}
auth: none
cert: false
user-data-dir: ${HOME}
EOL
)

(
umask 077
cat > "${PROXY_FILE}" << EOL
http_address="0.0.0.0:${port}"
cookie_secret="OQINaROshtE9TcZkNAm-5Zs2Pv3xaWytBmc5W7sPX7w="
provider="oidc"
email_domains="localhost"
oidc_issuer_url="http://localhost:5556"
client_secret="b5f6461a-ba0c-4c5c-9284-ba9e9aa29843"
client_id="localhost"
cookie_secure="false"
redirect_url="http://localhost:8080/oidc"
upstreams="http://0.0.0.0:${app_port}"
EOL
)
